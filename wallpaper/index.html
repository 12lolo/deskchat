<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>deskchat live — wallpaper</title>
  <style>
    :root {
      --bg1: #0f172a; /* slate-900 */
      --bg2: #1e293b; /* slate-800 */
      --card: rgba(255,255,255,0.08);
      --text: #e5e7eb; /* gray-200 */
      --muted: #94a3b8; /* slate-400 */
      --accent: #60a5fa; /* blue-400 */
      --shadow: rgba(0,0,0,0.35);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;
      --font-size: clamp(14px, 1.6vw, 22px);
      --max-messages: 100;
    }

    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background: radial-gradient(120% 120% at 100% 0%, var(--bg2), var(--bg1));
      color: var(--text);
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
      user-select: none;
      pointer-events: none; /* Let desktop clicks pass through */
    }

    .wrap {
      position: absolute; inset: 0; padding: 4vh 5vw; box-sizing: border-box;
      display: grid; grid-template-rows: auto 1fr auto; gap: 2vh;
    }

    .headline {
      font-weight: 600; letter-spacing: 0.02em; font-size: clamp(16px, 2vw, 26px);
      color: var(--muted);
      text-shadow: 0 1px 2px var(--shadow);
    }

    #feed {
      display: flex; flex-direction: column; gap: 10px; align-self: stretch;
      overflow: hidden; /* no scrollbars in wallpaper */
    }

    .msg {
      max-width: 70ch; padding: 10px 14px; border-radius: 10px;
      background: var(--card); backdrop-filter: blur(6px);
      box-shadow: 0 4px 14px var(--shadow);
      opacity: 0; transform: translateY(8px);
      transition: opacity 260ms ease, transform 260ms ease;
    }
    .msg.show { opacity: 1; transform: translateY(0); }

    .meta { font-size: 0.85em; color: var(--muted); margin-bottom: 4px; }
    .handle { color: var(--accent); font-weight: 600; }
    .content { font-size: var(--font-size); line-height: 1.35; white-space: pre-wrap; word-wrap: break-word; }

    .status {
      align-self: end; justify-self: end; color: var(--muted); font-size: 12px;
      text-shadow: 0 1px 2px var(--shadow);
    }

    .watermark { position: absolute; bottom: 2vh; left: 5vw; opacity: 0.3; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="headline">deskchat live</div>
    <div id="feed" aria-live="polite" aria-busy="false"></div>
    <div class="status" id="status">Connecting…</div>
    <div class="watermark">Press D for debug</div>
  </div>

  <script>
    (function () {
      'use strict';

      // Config via URL params (e.g., ?api=https://api.deskchat.live&interval=2500&limit=30&max=100)
      const params = new URLSearchParams(location.search);
      const API_BASE = (params.get('api') || 'https://api.deskchat.live').replace(/\/$/, '');
      const POLL_MS = Math.max(800, Number(params.get('interval') || 2500));
      const PAGE_LIMIT = Math.min(100, Math.max(1, Number(params.get('limit') || 30)));
      const MAX_DOM = Math.min(300, Math.max(10, Number(params.get('max') || 100)));

      // DOM elements
      const feed = document.getElementById('feed');
      const status = document.getElementById('status');

      // State
      let lastId = 0;
      let timer = null;
      let backoff = POLL_MS;
      let debug = false;

      function log(...a) { if (debug) console.log('[deskchat]', ...a); }

      function setStatus(text) {
        status.textContent = text;
      }

      function visible() { return !document.hidden; }

      function escapeText(s) {
        // Ensure string and strip control chars
        return String(s ?? '').replace(/[\u0000-\u001F\u007F]/g, '');
      }

      function isoToLocal(iso) {
        try { return new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        catch { return '' }
      }

      function render(messages) {
        for (const m of messages) {
          const wrap = document.createElement('div');
          wrap.className = 'msg';

          const meta = document.createElement('div');
          meta.className = 'meta';
          const handle = document.createElement('span');
          handle.className = 'handle';
          handle.textContent = escapeText(m.handle || 'Anon');
          const ts = document.createElement('span');
          ts.textContent = ' · ' + escapeText(isoToLocal(m.ts));
          meta.appendChild(handle); meta.appendChild(ts);

          const content = document.createElement('div');
          content.className = 'content';
          content.textContent = escapeText(m.content || '');

          wrap.appendChild(meta);
          wrap.appendChild(content);
          feed.appendChild(wrap);

          // Force transition
          requestAnimationFrame(() => wrap.classList.add('show'));
        }

        // Trim DOM to MAX_DOM (remove oldest from top)
        while (feed.children.length > MAX_DOM) {
          feed.removeChild(feed.firstChild);
        }
      }

      async function tick() {
        if (!visible()) { setStatus('Paused (hidden)'); schedule(); return; }
        try {
          const url = `${API_BASE}/api/messages?since_id=${lastId}&limit=${PAGE_LIMIT}`;
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          const items = Array.isArray(data.messages) ? data.messages : [];

          if (items.length) {
            render(items);
            lastId = Number(data.last_id || items[items.length-1]?.id || lastId);
            setStatus(`Updated · ${new Date().toLocaleTimeString()}`);
          } else {
            // Update lastId anyway for consistency with API contract
            lastId = Number(data.last_id ?? lastId);
            setStatus('No new messages');
          }
          backoff = POLL_MS; // reset on success
        } catch (err) {
          log('poll error:', err);
          setStatus('Error — backing off');
          backoff = Math.min(Math.max(backoff * 1.6, POLL_MS), 10000);
        } finally {
          schedule();
        }
      }

      function schedule() {
        clearTimeout(timer); timer = setTimeout(tick, backoff);
      }

      document.addEventListener('visibilitychange', () => {
        if (visible()) { setStatus('Resumed'); backoff = POLL_MS; tick(); }
      });

      window.addEventListener('keydown', (e) => {
        if (e.key === 'd' || e.key === 'D') {
          debug = !debug; setStatus(debug ? 'Debug ON' : 'Debug OFF');
        }
      });

      // Kick-off: prime lastId with a first page so we don't flood the screen initially
      (async function init() {
        try {
          const url = `${API_BASE}/api/messages?limit=${PAGE_LIMIT}`;
          const res = await fetch(url, { cache: 'no-store' });
          if (res.ok) {
            const data = await res.json();
            const items = Array.isArray(data.messages) ? data.messages : [];
            render(items);
            lastId = Number(data.last_id || 0);
            setStatus(`Ready · ${items.length} loaded`);
          } else {
            setStatus('Init failed');
          }
        } catch {
          setStatus('Init error');
        } finally {
          schedule();
        }
      })();
    })();
  </script>
</body>
</html>
